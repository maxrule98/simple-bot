version: '3.8'

services:
  # Example: BTC/USDT trading on MEXC with 1h timeframe
  trader-btc-usdt-mexc-1h:
    build: .
    container_name: trader-btc-usdt-mexc-1h
    command: python apps/trader/main.py --config /app/config/strategies/btc_usdt_mexc_1h.yaml
    volumes:
      - ./data:/app/data              # Shared database
      - ./logs:/app/logs              # Shared logs
      - ./config/strategies:/app/config/strategies:ro  # Strategy configs (read-only)
    env_file:
      - .env                          # API keys and secrets
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

  # Example: BTC/USDT trading on MEXC with 4h timeframe
  trader-btc-usdt-mexc-4h:
    build: .
    container_name: trader-btc-usdt-mexc-4h
    command: python apps/trader/main.py --config /app/config/strategies/btc_usdt_mexc_4h.yaml
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
      - ./config/strategies:/app/config/strategies:ro
    env_file:
      - .env
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

  # Example: BTC/USDT trading on MEXC with 1m timeframe (high-frequency)
  trader-btc-usdt-mexc-1m:
    build: .
    container_name: trader-btc-usdt-mexc-1m
    command: python apps/trader/main.py --config /app/config/strategies/btc_usdt_mexc_1m.yaml
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
      - ./config/strategies:/app/config/strategies:ro
    env_file:
      - .env
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

  # Example: ETH/USDT trading on MEXC with 15m timeframe
  trader-eth-usdt-mexc-15m:
    build: .
    container_name: trader-eth-usdt-mexc-15m
    command: python apps/trader/main.py --config /app/config/strategies/eth_usdt_mexc_15m.yaml
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
      - ./config/strategies:/app/config/strategies:ro
    env_file:
      - .env
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

  # Backfiller service - runs once or on schedule to populate historical data
  backfiller:
    build: .
    container_name: backfiller
    command: python apps/backfiller/main.py
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
      - ./config:/app/config:ro
    env_file:
      - .env
    restart: "no"  # Run once
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G

  # Optional: Backtester service for testing strategies
  backtester:
    build: .
    container_name: backtester
    command: python apps/backtester/main.py --config /app/config/strategies/test_strategy.yaml
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
      - ./config/strategies:/app/config/strategies:ro
    env_file:
      - .env
    profiles:
      - testing  # Only runs when explicitly specified: docker-compose --profile testing up
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G

# Shared volumes
volumes:
  data:
    driver: local
  logs:
    driver: local
